<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Pedidos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            background-color: #0f172a;
            margin: 0;
            padding: 0;
            padding-top: 56px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Configuraci√≥n
        const API_URL = 'ctrl/ctrl-pedidos-simple.php';
        const SUBSIDIARIES_ID = 1; // ‚ö†Ô∏è CAMBIA ESTO

        // Funci√≥n useFetch simplificada
        async function useFetch(options) {
            try {
                const formData = new FormData();
                for (const key in options.data) {
                    formData.append(key, options.data[key]);
                }

                const response = await fetch(options.url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error en useFetch:', error);
                throw error;
            }
        }

        // Funci√≥n para formatear precios
        function formatPrice(value) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(value);
        }

        // Inicializar Dashboard
        $(async () => {
            try {
                console.log('Inicializando dashboard...');
                
                // Crear estructura b√°sica
                $('#root').html(`
                    <div class="container mx-auto p-4">
                        <div class="bg-[#1F2A37] rounded-lg p-6 mb-4">
                            <h1 class="text-3xl font-bold text-white mb-2">üìä Dashboard de Pedidos</h1>
                            <p class="text-gray-400">Resumen mensual ¬∑ Cotizaciones ¬∑ Pagados ¬∑ Cancelados</p>
                        </div>
                        
                        <div class="bg-[#1F2A37] rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="text-white text-sm mb-2 block">Mes:</label>
                                    <select id="mes" class="w-full bg-[#374151] text-white rounded px-3 py-2">
                                        ${Array.from({length: 12}, (_, i) => {
                                            const month = String(i + 1).padStart(2, '0');
                                            const name = new Date(0, i).toLocaleString('es-MX', { month: 'long' });
                                            return `<option value="${month}">${name}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-white text-sm mb-2 block">A√±o:</label>
                                    <select id="anio" class="w-full bg-[#374151] text-white rounded px-3 py-2">
                                        ${Array.from({length: 3}, (_, i) => {
                                            const year = 2025 - i;
                                            return `<option value="${year}">${year}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="btnBuscar" class="w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">
                                        Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>
                        
                        <div class="bg-[#1F2A37] rounded-lg p-6">
                            <canvas id="chartPedidos"></canvas>
                        </div>
                    </div>
                `);

                // Seleccionar mes actual
                const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
                $('#mes').val(currentMonth);

                // Evento del bot√≥n buscar
                $('#btnBuscar').on('click', loadDashboard);

                // Cargar datos iniciales
                await loadDashboard();

            } catch (error) {
                console.error('Error inicializando:', error);
                $('#root').html(`
                    <div class="container mx-auto p-4">
                        <div class="bg-red-900 text-white rounded-lg p-6">
                            <h2 class="text-xl font-bold mb-2">‚ùå Error</h2>
                            <p>${error.message}</p>
                            <p class="text-sm mt-2">Revisa la consola (F12) para m√°s detalles.</p>
                        </div>
                    </div>
                `);
            }
        });

        // Funci√≥n para cargar el dashboard
        async function loadDashboard() {
            try {
                console.log('Cargando datos del dashboard...');
                
                const mes = $('#mes').val();
                const anio = $('#anio').val();

                const data = await useFetch({
                    url: API_URL,
                    data: {
                        opc: 'apiVentas',
                        mes: mes,
                        anio: anio,
                        subsidiaries_id: SUBSIDIARIES_ID
                    }
                });

                console.log('Datos recibidos:', data);

                if (data.cards) {
                    renderCards(data.cards);
                    renderChart(data.cards);
                } else {
                    console.error('No se recibieron datos de cards');
                }

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                alert('Error al cargar los datos. Revisa la consola para m√°s detalles.');
            }
        }

        // Renderizar cards
        function renderCards(cards) {
            const cardsHTML = `
                <div class="bg-[#1F2A37] rounded-lg p-6">
                    <h3 class="text-gray-400 text-sm mb-2">Pedidos del mes</h3>
                    <p class="text-3xl font-bold text-purple-400">${cards.total_pedidos}</p>
                    <p class="text-xs text-gray-500 mt-2">
                        ${cards.desglose.cotizaciones} cotizaciones ‚Ä¢ 
                        ${cards.desglose.pagados} pagados ‚Ä¢ 
                        ${cards.desglose.cancelados} cancelados
                    </p>
                </div>
                
                <div class="bg-[#1F2A37] rounded-lg p-6">
                    <h3 class="text-gray-400 text-sm mb-2">Dinero entrante</h3>
                    <p class="text-3xl font-bold text-pink-400">${formatPrice(cards.dinero_entrante)}</p>
                    <p class="text-xs text-gray-500 mt-2">Total de pagos recibidos</p>
                </div>
                
                <div class="bg-[#1F2A37] rounded-lg p-6">
                    <h3 class="text-gray-400 text-sm mb-2">Ventas cerradas</h3>
                    <p class="text-3xl font-bold text-cyan-400">${formatPrice(cards.ventas_cerradas.monto)}</p>
                    <p class="text-xs text-gray-500 mt-2">${cards.ventas_cerradas.cantidad} pedidos completados</p>
                </div>
                
                <div class="bg-[#1F2A37] rounded-lg p-6">
                    <h3 class="text-gray-400 text-sm mb-2">Cancelaciones</h3>
                    <p class="text-3xl font-bold text-red-400">${formatPrice(cards.cancelaciones.monto)}</p>
                    <p class="text-xs text-gray-500 mt-2">${cards.cancelaciones.cantidad} pedidos cancelados</p>
                </div>
            `;

            $('#cards').html(cardsHTML);
        }

        // Renderizar gr√°fico
        let chartInstance = null;
        function renderChart(cards) {
            const ctx = document.getElementById('chartPedidos');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cotizaciones', 'Pagados', 'Cancelados'],
                    datasets: [{
                        label: 'Cantidad de Pedidos',
                        data: [
                            cards.desglose.cotizaciones,
                            cards.desglose.pagados,
                            cards.desglose.cancelados
                        ],
                        backgroundColor: ['#EC4899', '#10B981', '#F97316'],
                        borderColor: ['#EC4899', '#10B981', '#F97316'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
