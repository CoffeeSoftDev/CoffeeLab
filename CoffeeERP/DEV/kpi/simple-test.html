<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple KPI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Test Simple KPI Campa침as</h1>
        
        <div id="root" class="mt-4">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p>Inicializando...</p>
            </div>
        </div>
    </div>

    <script>
        // Funci칩n simple para hacer peticiones AJAX
        async function useFetch(options) {
            const formData = new FormData();
            for (const key in options.data) {
                formData.append(key, options.data[key]);
            }
            
            const response = await fetch(options.url, {
                method: 'POST',
                body: formData
            });
            
            return await response.json();
        }

        // Variables globales
        let udnList = [];
        let campaignsList = [];
        let typesList = [];
        let classificationsList = [];
        let socialNetworksList = [];

        // Clase base simple
        class Templates {
            constructor(link, div_modulo) {
                this._link = link;
                this._div_modulo = div_modulo;
            }

            primaryLayout(options) {
                const html = `
                    <div id="${options.id}" class="${options.class}">
                        <div id="${options.card.filterBar.id}" class="${options.card.filterBar.class}"></div>
                        <div id="${options.card.container.id}" class="${options.card.container.class}"></div>
                    </div>
                `;
                $(`#${options.parent}`).html(html);
            }

            tabLayout(options) {
                let tabsHtml = '<ul class="nav nav-tabs" id="' + options.id + '-tabs">';
                let contentHtml = '<div class="tab-content mt-3">';

                options.json.forEach((tab, index) => {
                    const activeClass = tab.active ? 'active' : '';
                    tabsHtml += `
                        <li class="nav-item">
                            <a class="nav-link ${activeClass}" href="#container-${tab.id}" data-bs-toggle="tab" onclick="${tab.onClick ? tab.onClick.toString().replace('() => ', '').replace('()', '') + '()' : ''}">${tab.tab}</a>
                        </li>
                    `;
                    
                    contentHtml += `
                        <div class="tab-pane fade ${activeClass ? 'show active' : ''}" id="container-${tab.id}">
                            <p>Contenido de ${tab.tab}</p>
                        </div>
                    `;
                });

                tabsHtml += '</ul>';
                contentHtml += '</div>';

                $(`#${options.parent}`).html(tabsHtml + contentHtml);
            }
        }

        // Clase Campaign simplificada
        class Campaign extends Templates {
            constructor(link, div_modulo) {
                super(link, div_modulo);
                this.PROJECT_NAME = "Campaign";
            }

            init() {
                this.render();
            }

            render() {
                this.layout();
                this.layoutTabs();
            }

            layout() {
                this.primaryLayout({
                    parent: 'root',
                    id: this.PROJECT_NAME,
                    class: 'container-fluid',
                    card: {
                        filterBar: { class: 'w-full my-3', id: 'filterBar' + this.PROJECT_NAME },
                        container: { class: 'w-full h-full rounded-lg p-3', id: 'container' + this.PROJECT_NAME }
                    }
                });

                $("#filterBar" + this.PROJECT_NAME).html(`
                    <div class="px-4 pt-3">
                        <h2 class="text-2xl font-semibold">游늵 M칩dulo de Campa침as</h2>
                        <p class="text-muted">Gestiona campa침as de marketing, anuncios y an치lisis de rendimiento.</p>
                    </div>
                `);
            }

            layoutTabs() {
                this.tabLayout({
                    parent: "container" + this.PROJECT_NAME,
                    id: "tabsCampaignMain",
                    json: [
                        {
                            id: "dashboard",
                            tab: "Dashboard",
                            onClick: () => this.renderDashboard(),
                            active: true
                        },
                        {
                            id: "anuncios",
                            tab: "Anuncios",
                            onClick: () => this.renderAnuncios()
                        },
                        {
                            id: "resumen",
                            tab: "Resumen",
                            onClick: () => this.renderResumen()
                        }
                    ]
                });
            }

            renderDashboard() {
                $("#container-dashboard").html(`
                    <div class="alert alert-success">
                        <h4>Dashboard</h4>
                        <p>Aqu칤 se mostrar칤an las m칠tricas y KPIs.</p>
                        <p><strong>UDN disponibles:</strong> ${udnList.length}</p>
                        <p><strong>Campa침as:</strong> ${campaignsList.length}</p>
                        <p><strong>Tipos:</strong> ${typesList.length}</p>
                    </div>
                `);
            }

            renderAnuncios() {
                $("#container-anuncios").html(`
                    <div class="alert alert-info">
                        <h4>Gesti칩n de Anuncios</h4>
                        <p>Aqu칤 se gestionar칤an los anuncios.</p>
                    </div>
                `);
            }

            renderResumen() {
                $("#container-resumen").html(`
                    <div class="alert alert-warning">
                        <h4>Resumen de Campa침as</h4>
                        <p>Aqu칤 se mostrar칤an los reportes.</p>
                    </div>
                `);
            }
        }

        // Inicializaci칩n
        $(document).ready(async function() {
            console.log("Iniciando test simple...");
            
            try {
                // Cargar datos iniciales
                const data = await useFetch({ 
                    url: 'ctrl/ctrl-kpi-campaign.php', 
                    data: { opc: 'init' } 
                });
                
                console.log("Datos recibidos:", data);
                
                if (data && data.status !== 500) {
                    udnList = data.udn || [];
                    campaignsList = data.campaigns || [];
                    typesList = data.types || [];
                    classificationsList = data.classifications || [];
                    socialNetworksList = data.socialNetworks || [];
                    
                    // Crear e inicializar campa침a
                    const campaign = new Campaign('ctrl/ctrl-kpi-campaign.php', 'root');
                    campaign.init();
                    
                    console.log("M칩dulo inicializado correctamente");
                } else {
                    throw new Error(data.message || 'Error del servidor');
                }
                
            } catch (error) {
                console.error("Error:", error);
                $("#root").html(`
                    <div class="alert alert-danger">
                        <h4>Error</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">Reintentar</button>
                    </div>
                `);
            }
        });
    </script>
</body>
</html>